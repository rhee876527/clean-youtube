From 8fbb11079b04e3765aa22fc111b289e414593cf3 Mon Sep 17 00:00:00 2001
From: Martin Kibera <martin.kibera.n@gmail.com>
Date: Sat, 24 Jan 2026 17:36:42 +0300
Subject: [PATCH] fix firefox av sync issues

---
 html/static/js/player.js | 33 ++++++++++++++++++++++++---------
 1 file changed, 24 insertions(+), 9 deletions(-)

diff --git a/html/static/js/player.js b/html/static/js/player.js
index a972337..04a7811 100644
--- a/html/static/js/player.js
+++ b/html/static/js/player.js
@@ -443,16 +443,30 @@ function throttle(func, delay) {
 function startSyncCheck() {
     if (!formatLoader.npa || audioElement.readyState < 3) return;
 
+    const driftThreshold = 0.3;
+    const syncInterval = 300;
+
     const sync = throttle(() => {
-        const audioEnd = audioElement.buffered.length
-            ? audioElement.buffered.end(audioElement.buffered.length - 1)
-            : 0;
+        if (videoElement.paused || audioElement.paused) return;
+
+        const videoTime = videoElement.currentTime;
+        const audioTime = audioElement.currentTime;
+        const drift = videoTime - audioTime;
+
+        if (Math.abs(drift) > driftThreshold) {
+            // Check if audio buffer is sufficient before correcting
+            const audioEnd = audioElement.buffered.length
+                ? audioElement.buffered.end(audioElement.buffered.length - 1)
+                : 0;
+            const bufferLead = audioEnd - videoTime;
+
+            const minBufferLead = 2.0;
 
-        if (audioEnd - videoElement.currentTime >= 0.5 && !videoElement.paused && !audioElement.paused) {
-            const drift = Math.abs(videoElement.currentTime - audioElement.currentTime);
-            if (drift > 0.1) audioElement.currentTime = videoElement.currentTime;
+            if (bufferLead >= minBufferLead) {
+                audioElement.currentTime = videoTime;
+            }
         }
-    }, 200);
+    }, syncInterval);
 
     videoElement.removeEventListener('timeupdate', sync);
     videoElement.addEventListener('timeupdate', sync);
@@ -509,14 +523,15 @@ async function waitForAudioThenPlay(videoEl, audioEl) {
         return;
     }
 
-    // Wait until audio has at least 3s buffered ahead of video
+    // Wait until audio has sufficient buffer ahead of video
+    const requiredBuffer = 6;
     await new Promise(resolve => {
         const check = () => {
             const audioEnd = audioEl.buffered.length
                 ? audioEl.buffered.end(audioEl.buffered.length - 1)
                 : 0;
 
-            if (audioEnd - videoEl.currentTime >= 3) return resolve();
+            if (audioEnd - videoEl.currentTime >= requiredBuffer) return resolve();
             requestAnimationFrame(check);
         };
         check();
-- 
2.53.0

